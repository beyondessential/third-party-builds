name: APT Repository

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *" # Twice a day
  workflow_run:
    workflows: ["crun", "netavark", "podman", "caddy"]
    types: [completed]
    branches: [main]
  push:
    branches:
      - main
    paths:
      - .github/workflows/apt-repo.yml

permissions:
  id-token: write
  contents: read

concurrency:
  group: apt-repo
  cancel-in-progress: false

jobs:
  generate-repo:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' }}
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev gzip gnupg

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          gpg --list-secret-keys

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-southeast-2
          role-to-assume: arn:aws:iam::143295493206:role/gha-tamanu-tools-upload
          role-session-name: GHA@3PB=apt-repo

      - name: Download all .deb files from S3
        run: |
          mkdir -p repo/pool
          aws s3 sync s3://bes-ops-tools/crun/ repo/pool/crun/ --exclude "*" --include "*.deb" --no-progress
          aws s3 sync s3://bes-ops-tools/podman/ repo/pool/podman/ --no-progress --exclude "*" --include "*.deb"
          aws s3 sync s3://bes-ops-tools/netavark/ repo/pool/netavark/ --no-progress --exclude "*" --include "*.deb"
          aws s3 sync s3://bes-ops-tools/caddy/ repo/pool/caddy/ --no-progress --exclude "*" --include "*.deb"
          aws s3 sync s3://bes-ops-tools/bestool/ repo/pool/bestool/ --no-progress --exclude "*" --include "*.deb"
          find repo/pool -name "*.deb" -type f

      - name: Generate repository metadata for amd64
        run: |
          mkdir -p repo/dists/stable/main/binary-amd64
          cd repo
          dpkg-scanpackages --arch amd64 pool /dev/null | gzip -9c > dists/stable/main/binary-amd64/Packages.gz
          dpkg-scanpackages --arch amd64 pool /dev/null > dists/stable/main/binary-amd64/Packages

      - name: Generate repository metadata for arm64
        run: |
          mkdir -p repo/dists/stable/main/binary-arm64
          cd repo
          dpkg-scanpackages --arch arm64 pool /dev/null | gzip -9c > dists/stable/main/binary-arm64/Packages.gz
          dpkg-scanpackages --arch arm64 pool /dev/null > dists/stable/main/binary-arm64/Packages

      - name: Generate Release file
        run: |
          cd repo/dists/stable

          cat > Release <<EOF
          Origin: BES Tools
          Label: BES Tools
          Suite: stable
          Codename: stable
          Architectures: amd64 arm64
          Components: main
          Description: Tools and runtimes for BES deployments
          Date: $(date -Ru)
          EOF

          # Generate checksums
          echo "MD5Sum:" >> Release
          find main -type f | while read file; do
            md5sum "$file" | awk '{print " " $1, "'$(stat -c%s "$file")'", "'"$file"'"}' >> Release
          done

          echo "SHA1:" >> Release
          find main -type f | while read file; do
            sha1sum "$file" | awk '{print " " $1, "'$(stat -c%s "$file")'", "'"$file"'"}' >> Release
          done

          echo "SHA256:" >> Release
          find main -type f | while read file; do
            sha256sum "$file" | awk '{print " " $1, "'$(stat -c%s "$file")'", "'"$file"'"}' >> Release
          done

      - name: Sign Release
        run: |
          cd repo/dists/stable
          gpg --export --armor ${{ vars.GPG_KEY_ID }} > ../../bes-tools.gpg.key
          gpg --batch --yes --no-tty --pinentry-mode loopback --default-key ${{ vars.GPG_KEY_ID }} -abs -o Release.gpg Release
          gpg --batch --yes --no-tty --pinentry-mode loopback --default-key ${{ vars.GPG_KEY_ID }} --clearsign -o InRelease Release

      - name: Upload repository to S3
        run: |
          aws s3 sync repo/ s3://bes-ops-tools/apt/ --delete --no-progress

          # Set proper content types

          aws s3 cp s3://bes-ops-tools/apt/ s3://bes-ops-tools/apt/ \
            --exclude "*" \
            --include "*.deb" \
            --recursive \
            --no-guess-mime-type \
            --content-type "application/vnd.debian.binary-package" \
            --metadata-directive REPLACE \
            --no-progress

          aws s3 cp s3://bes-ops-tools/apt/ s3://bes-ops-tools/apt/ \
            --exclude "*" \
            --include "Packages*" \
            --recursive \
            --no-guess-mime-type \
            --content-type "text/plain" \
            --metadata-directive REPLACE \
            --no-progress

          aws s3 cp s3://bes-ops-tools/apt/ s3://bes-ops-tools/apt/ \
            --exclude "*" \
            --include "Release*" \
            --recursive \
            --no-guess-mime-type \
            --content-type "text/plain" \
            --metadata-directive REPLACE \
            --no-progress

      - name: Clear CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id=EDAG0UBS1MN74 \
            --paths '/apt/*'

  test-repo:
    needs: generate-repo
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64]
    steps:
      - name: Wait for CloudFront cache to clear
        run: sleep 30

      - name: Add APT repository
        run: |
          curl -fsSL https://tools.ops.tamanu.io/apt/bes-tools.gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/bes-tools.gpg
          echo "deb [signed-by=/etc/apt/keyrings/bes-tools.gpg] https://tools.ops.tamanu.io/apt stable main" | sudo tee /etc/apt/sources.list.d/bes-tools.list
          sudo tee /etc/apt/preferences.d/bes-tools <<EOF
          Package: *
          Pin: origin tools.ops.tamanu.io
          Pin-Priority: 999
          EOF
          sudo apt-get update

      - name: Install packages from repository
        run: |
          sudo apt-get install -y caddy crun netavark podman

      - name: Verify installations
        run: |
          caddy version
          crun --version
          /usr/local/libexec/podman/netavark --version
          podman --version

      - name: Check systemd units (caddy)
        run: |
          systemctl cat caddy.service
          systemctl cat caddy.socket

      - name: Verify user/group created
        run: |
          id caddy
          groups caddy
